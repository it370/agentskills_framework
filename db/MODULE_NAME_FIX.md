# Module Name Fix Guide

## Problem

After adding the `module_name` column to `dynamic_skills`, existing skills may still have incorrect module paths in their `action_config.module` field. This causes errors like:

```
Cannot import module 'dynamic_skills.': No module named 'dynamic_skills'
```

Or:

```
Cannot import module 'dynamic_skills.Test My Grammar': No module named 'dynamic_skills.Test My Grammar'
```

## Root Cause

1. **Before migration**: Skills stored module paths like `dynamic_skills.Test My Grammar` (with spaces!)
2. **After migration**: Module names are sanitized to `test_my_grammar`, but old `action_config.module` still has the invalid path
3. **New skills**: Admin UI was setting `action_config.module` using the raw skill name instead of the sanitized `module_name`

## The Fix

### 1. Backend Automatically Corrects Module Paths (✅ Implemented)

The `skill_manager.py` now automatically updates `action_config.module` when loading skills:

```python
# In load_skills_from_database()
if action_config.get("type") == "python_function" and action_code:
    # Register the function with the sanitized module_name
    _register_inline_action(module_name, function_name, action_code)
    
    # Update action_config to use correct module path
    action_config["module"] = f"dynamic_skills.{module_name}"
```

### 2. Admin UI No Longer Sets Module Path (✅ Implemented)

The admin UI now lets the backend handle module paths automatically:

```typescript
// Before (❌ Wrong)
skillData.action_config.module = `dynamic_skills.${name}`;  // Uses raw name!

// After (✅ Correct)
// Module name will be set automatically from the sanitized skill name by the backend
// No need to set it manually
```

### 3. Database Update for Existing Skills

For existing skills with wrong module paths in the database, run the fix script:

```bash
python db/fix_module_paths.py
```

This will:
- Find all python_function skills
- Check if their `action_config.module` matches `dynamic_skills.{module_name}`
- Update any mismatched module paths
- Verify all fixes were applied correctly

## How Module Names Work

### Name to Module Name Conversion

The database automatically converts skill names to valid Python module names:

| Skill Name | Module Name | Module Path |
|------------|-------------|-------------|
| "Test My Grammar" | "test_my_grammar" | "dynamic_skills.test_my_grammar" |
| "Data Processing 2024" | "data_processing_2024" | "dynamic_skills.data_processing_2024" |
| "REST-API Validator!" | "rest_api_validator" | "dynamic_skills.rest_api_validator" |

### Module Registration Process

1. **Insert/Update**: Skill name is saved → Database trigger generates `module_name`
2. **Load**: Backend reads skill → Registers Python function using `module_name`
3. **Execute**: Engine imports from `dynamic_skills.{module_name}` module

### Example Flow

```python
# 1. User creates skill "Test My Grammar" via UI
skill = {
    "name": "Test My Grammar",
    "action_config": {
        "type": "python_function",
        "function": "check_grammar"
    }
}

# 2. Database saves and generates module_name
# name = "Test My Grammar"
# module_name = "test_my_grammar" (auto-generated by trigger)

# 3. Backend loads and registers
_register_inline_action("test_my_grammar", "check_grammar", action_code)
# Creates module: dynamic_skills.test_my_grammar

# 4. Backend updates action_config
action_config["module"] = "dynamic_skills.test_my_grammar"

# 5. Engine executes
func_key = "dynamic_skills.test_my_grammar.check_grammar"
func = ACTION_REGISTRY[func_key]  # ✓ Found!
```

## Troubleshooting

### Error: "Cannot import module 'dynamic_skills.'"

**Cause**: Empty module name in `action_config.module`

**Fix**:
```bash
python db/fix_module_paths.py
```

### Error: "Cannot import module 'dynamic_skills.My Skill Name'"

**Cause**: Module path contains spaces or special characters

**Fix**:
```bash
python db/fix_module_paths.py
```

Then restart your application.

### Error: Function not found after fix

**Cause**: Function may not be registered correctly

**Fix**:
1. Check the skill's `action_code` is valid Python
2. Check the `function` name in `action_config` matches the function in `action_code`
3. Reload skills: `POST /admin/skills/reload`

### Module path still wrong after fix

**Cause**: Skill may have been cached

**Fix**:
1. Restart the application completely
2. Or reload skills via API: `POST /admin/skills/reload`

## Verification

### Check Module Names in Database

```sql
SELECT 
    name,
    module_name,
    action_config->>'module' as module_path,
    action_config->>'function' as function_name
FROM dynamic_skills
WHERE executor = 'action'
  AND action_config->>'type' = 'python_function';
```

### Expected Output

```
name               | module_name         | module_path                         | function_name
-------------------+---------------------+-------------------------------------+--------------
Test My Grammar    | test_my_grammar     | dynamic_skills.test_my_grammar     | check_grammar
Data Processor     | data_processor      | dynamic_skills.data_processor      | process_data
```

All `module_path` values should be `dynamic_skills.{module_name}`.

## Prevention

### For Developers

1. **Never set `action_config.module` manually** - Let the backend handle it
2. **Always use `module_name` field** - Not the raw skill `name`
3. **Test skills after creation** - Verify they execute without import errors

### For Users

1. **Use any skill name you want** - Spaces, special characters, etc. are fine
2. **Module names are automatic** - The system handles conversion
3. **Run fix script after migration** - Ensures existing skills work

## Summary

- ✅ **Database**: Auto-generates `module_name` from skill `name`
- ✅ **Backend**: Uses `module_name` for module registration
- ✅ **Backend**: Automatically fixes `action_config.module` on load
- ✅ **Admin UI**: No longer sets module paths manually
- ✅ **Fix Script**: Updates existing skills with wrong paths

The system now handles module naming completely automatically. Users can create skills with any name, and the system ensures they work correctly!
