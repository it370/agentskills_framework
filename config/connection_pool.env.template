# Connection Pool Configuration Template
#
# Copy this to your .env file and adjust values based on your environment
#
# See documentations/CONNECTION_POOLING.md for detailed guidance

# =============================================================================
# PostgreSQL Connection Pool
# =============================================================================

# Maximum number of connections in the pool
# - Development: 15-20
# - Production (low traffic): 20-30
# - Production (high traffic): 40-60
# - High concurrency: 80-100
POSTGRES_POOL_MAX_SIZE=30

# Minimum number of connections to maintain
# - Development: 2-5
# - Production: 5-10
# - High concurrency: 10-20
POSTGRES_POOL_MIN_SIZE=5

# Maximum number of clients waiting for a connection
# Clients beyond this will immediately get an error
POSTGRES_POOL_MAX_WAITING=10

# Timeout (seconds) waiting for a connection from pool
# Increase if you have long-running queries
POSTGRES_POOL_TIMEOUT=30.0

# Connection maximum lifetime (seconds)
# Connections older than this will be closed and recreated
# Default: 3600 (1 hour)
POSTGRES_POOL_MAX_LIFETIME=3600

# Maximum idle time (seconds) before closing a connection
# Default: 600 (10 minutes)
POSTGRES_POOL_MAX_IDLE=600

# Timeout (seconds) for reconnection attempts
# Default: 300 (5 minutes)
POSTGRES_POOL_RECONNECT_TIMEOUT=300

# =============================================================================
# MongoDB Connection Pool
# =============================================================================

# Maximum number of connections per MongoDB host
# - Development: 10-15
# - Production (low traffic): 20-30
# - Production (high traffic): 40-60
MONGO_MAX_POOL_SIZE=20

# Minimum number of connections to maintain
# - Development: 2-5
# - Production: 5-10
MONGO_MIN_POOL_SIZE=5

# Maximum idle time (milliseconds) before closing a connection
# Default: 300000 (5 minutes)
MONGO_MAX_IDLE_TIME_MS=300000

# Timeout (milliseconds) waiting for a connection from pool
# Default: 30000 (30 seconds)
MONGO_WAIT_QUEUE_TIMEOUT_MS=30000

# Timeout (milliseconds) for server selection
# Default: 30000 (30 seconds)
MONGO_SERVER_SELECTION_TIMEOUT_MS=30000

# Timeout (milliseconds) for initial connection
# Default: 20000 (20 seconds)
MONGO_CONNECT_TIMEOUT_MS=20000

# Timeout (milliseconds) for socket operations
# Increase for long-running queries
# Default: 60000 (60 seconds)
MONGO_SOCKET_TIMEOUT_MS=60000

# =============================================================================
# Environment-Specific Examples
# =============================================================================

# --- Local Development ---
# Small pools, lower timeouts
# POSTGRES_POOL_MAX_SIZE=15
# POSTGRES_POOL_MIN_SIZE=3
# MONGO_MAX_POOL_SIZE=10
# MONGO_MIN_POOL_SIZE=2

# --- Staging ---
# Moderate pools, standard timeouts
# POSTGRES_POOL_MAX_SIZE=25
# POSTGRES_POOL_MIN_SIZE=5
# MONGO_MAX_POOL_SIZE=20
# MONGO_MIN_POOL_SIZE=5

# --- Production (Standard) ---
# Larger pools, standard timeouts
# POSTGRES_POOL_MAX_SIZE=40
# POSTGRES_POOL_MIN_SIZE=10
# MONGO_MAX_POOL_SIZE=30
# MONGO_MIN_POOL_SIZE=10

# --- Production (High Concurrency) ---
# Very large pools, extended timeouts
# POSTGRES_POOL_MAX_SIZE=80
# POSTGRES_POOL_MIN_SIZE=20
# POSTGRES_POOL_TIMEOUT=60.0
# POSTGRES_POOL_MAX_WAITING=30
# MONGO_MAX_POOL_SIZE=60
# MONGO_MIN_POOL_SIZE=15

# =============================================================================
# Monitoring Thresholds
# =============================================================================

# Set up alerts when these thresholds are exceeded:
#
# - Pool utilization > 75%: Warning
# - Pool utilization > 90%: Critical
# - Waiting clients > 5: Warning
# - Waiting clients > 10: Critical
#
# Check pool stats at: GET /admin/pool-stats
# Check health at: GET /health

# =============================================================================
# Database Configuration (Required)
# =============================================================================

# PostgreSQL connection string (required for Postgres pool)
DATABASE_URL=postgresql://user:password@host:5432/database

# MongoDB connection string (required for MongoDB pool)
MONGODB_URI=mongodb://host:27017
MONGODB_DB=database_name

# =============================================================================
# Performance Tuning Tips
# =============================================================================

# 1. Connection Pool Size
#    - Calculate based on: (number of services) * (avg concurrent requests) * 1.5
#    - Example: 4 services * 10 requests * 1.5 = 60 connections
#
# 2. Timeouts
#    - Set POSTGRES_POOL_TIMEOUT higher than longest expected query
#    - Monitor query performance and optimize slow queries
#    - Consider separate pools for long-running vs. short queries
#
# 3. Monitoring
#    - Set up automated monitoring of /admin/pool-stats
#    - Alert on high utilization (>75%) or waiting clients
#    - Review and adjust pool sizes based on actual usage
#
# 4. Database Server
#    - Ensure database max_connections > POSTGRES_POOL_MAX_SIZE
#    - Typical: Set database max_connections to 2x pool size for safety
#    - Example: POSTGRES_POOL_MAX_SIZE=50 â†’ database max_connections=100+

# =============================================================================
# Troubleshooting
# =============================================================================

# Issue: "Too many connections" error
# Solution: Increase POSTGRES_POOL_MAX_SIZE or database max_connections

# Issue: Timeouts waiting for connections
# Solution: Increase POSTGRES_POOL_TIMEOUT or optimize slow queries

# Issue: High pool utilization (>80%)
# Solution: Increase POSTGRES_POOL_MAX_SIZE

# Issue: Many waiting clients
# Solution: Increase POSTGRES_POOL_MAX_SIZE and POSTGRES_POOL_MAX_WAITING

# Issue: MongoDB connection timeouts
# Solution: Increase MONGO_WAIT_QUEUE_TIMEOUT_MS or MONGO_MAX_POOL_SIZE
